<!DOCTYPE HTML>
<html>
<head>
    <title>Trivia Game</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='triviastyle.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js" integrity="sha512-aMGMvNYu8Ue4G+fHa359jcPb1u+ytAF+P2SCb+PxrjCdO3n3ZTxJ30zuH39rimUggmTwmh2u7wvQsDTHESnmfQ==" crossorigin="anonymous"></script>
    <script type="text/javascript" charset="utf-8">

        function setCookie(name,value,days) {
            var expires = "";
            if (days) {
                var date = new Date();
                date.setTime(date.getTime() + (days*24*60*60*1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "")  + expires + "; path=/";
        }
        function getCookie(name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for(var i=0;i < ca.length;i++) {
                var c = ca[i];
                while (c.charAt(0)==' ') c = c.substring(1,c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
            }
            return null;
        }
        function eraseCookie(name) {   
            document.cookie = name +'=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
        }

        $(document).ready(function() {
            // Connect to the Socket.IO server.
            // The connection URL has the following format, relative to the current page:
            //     http[s]://<domain>:<port>[/<namespace>]
            var socket = io();

            var username = getCookie("username");
            var room = getCookie("room");

            if(room != null){
                $('#join_room').attr("value", room);
                $('#start_room_button').attr("value", room);
                $('#log').append('<br>room: ' + room);

            }
            if(username != null){
                $('#username').attr("value", username);
                $('#log').append('<br>username: ' + username);
            }
            

            // Event handler for new connections.
            // The callback function is invoked when a connection with the
            // server is established.
            socket.on('connect', function() {
                socket.emit('my_event', {data: 'I\'m connected!'});
            });

            // Event handler for server sent data.
            // The callback function is invoked whenever the server emits data
            // to the client. The data is then displayed in the "Received"
            // section of the page.
            socket.on('my_response', function(msg, cb) {
                $('#log').append('<br>' + $('<div/>').text('Received #' + msg.count + ': ' + msg.data).html());
                if (cb)
                    cb();
            });

            socket.on('my_question', function(msg, cb) {
                q = JSON.parse(msg.data);
                $('#question_zone').text($('<div/>').text('Question #' + msg.count + ': ' + q[2]).html());

                ans = "<form id='ans' method='POST' action='#'>";
                for (let i = 0; i < q[3].length; i++) {
                    ans += "<input type='button' value='" + q[3][i] + "' name='" + q[3][i] + "' >";
                }
                ans += "</form>";

                $('#question_zone').append(ans);

                //$('form#ans').click(function(event) {
                $('input:button').click(function(event) {
                    var btnValue = $(this).val();
                    // socket.emit('my_answer', {data: event});

                    socket.emit('my_answer', {room: $('#join_room').val(),
                                            username: $('#username').val(), 
                                            answer: btnValue });

                    return false;
                });

                if (cb)
                    cb();
            });

            socket.on('my_question_answer', function(msg, cb) {

                msg_json = JSON.parse(msg.data);

                $('#question_zone').text("");
                text = "";
                for (const [key, value] of Object.entries(msg_json)) {
                    text += key + value + "<br>";
                }
                text += "<br>";
                $('#question_zone').append(text);

            });

            socket.on('my_leaderboard', function(msg, cb) {

                msg_json = JSON.parse(msg.data);

                //$('#question_zone').text("");
                $('#room_leaderboard').text("");
                text = "";
                for (const [key, value] of Object.entries(msg_json)) {
                    text += key + " : " + value + "<br>";
                }
                text += "<br>";
                $('#room_leaderboard').text(text);

            });


            socket.on('my_countdown', function(msg, cb) {


                msg_json = JSON.parse(msg.data);

                text = "Time Left: " + msg_json[1] + " seconds <br>";
                $('#room_stats').text(text);
            });

            

            // Interval function that tests message latency by sending a "ping"
            // message. The server then responds with a "pong" message and the
            // round trip time is measured.
            var ping_pong_times = [];
            var start_time;
            window.setInterval(function() {
                start_time = (new Date).getTime();
                $('#transport').text(socket.io.engine.transport.name);
                socket.emit('my_ping');
            }, 1000);

            // Handler for the "pong" message. When the pong is received, the
            // time from the ping is stored, and the average of the last 30
            // samples is average and displayed.
            socket.on('my_pong', function() {
                var latency = (new Date).getTime() - start_time;
                ping_pong_times.push(latency);
                ping_pong_times = ping_pong_times.slice(-30); // keep last 30 samples
                var sum = 0;
                for (var i = 0; i < ping_pong_times.length; i++)
                    sum += ping_pong_times[i];
                $('#ping-pong').text(Math.round(10 * sum / ping_pong_times.length) / 10);
            });

            // Handlers for the different forms in the page.
            // These accept data from the user and send it to the server in a
            // variety of ways
            $('form#emit').submit(function(event) {
                socket.emit('my_event', {data: $('#emit_data').val()});
                return false;
            });
            $('form#broadcast').submit(function(event) {
                socket.emit('my_broadcast_event', {data: $('#broadcast_data').val()});
                return false;
            });
            // $('form#join').submit(function(event) {
            //     socket.emit('join', {room: $('#join_room').val()});
            //     return false;
            // });
            $('form#name_join').submit(function(event) {
                socket.emit('name_join', {username: $('#username').val(), room: $('#join_room').val()});
                $('#start_room_button').attr("value", room);
                setCookie("username", $('#username').val(), 1);
                setCookie("room", $('#join_room').val(), 1);
                return false;
            });
            $('form#start_room').submit(function(event) {
                socket.emit('start_room', {room: $('#start_room_button').val(), numofq: $('#question_num').val()});
                return false;
            });
            $('form#leave').submit(function(event) {
                socket.emit('leave', {room: $('#leave_room').val()});
                return false;
            });
            $('form#send_room').submit(function(event) {
                socket.emit('my_room_event', {room: $('#room_name').val(), data: $('#room_data').val()});
                return false;
            });
            $('form#close').submit(function(event) {
                socket.emit('close_room', {room: $('#close_room').val()});
                return false;
            });
            $('form#disconnect').submit(function(event) {
                socket.emit('disconnect_request');
                return false;
            });
        });
    </script>
</head>
<body>
    <h1>Trivia</h1>
    <!-- <p>
      Async mode is: <b>{{ async_mode }}</b><br>
      Current transport is: <b><span id="transport"></span></b><br>
      Average ping/pong latency: <b><span id="ping-pong"></span>ms</b>
    </p> -->
    <div id="menu">
        <h2>Menu:</h2>
        <!-- <form id="emit" method="POST" action='#'>
            <input type="text" name="emit_data" id="emit_data" placeholder="Message">
            <input type="submit" value="Echo">
        </form>
        <form id="broadcast" method="POST" action='#'>
            <input type="text" name="broadcast_data" id="broadcast_data" placeholder="Message">
            <input type="submit" value="Broadcast">
        </form> -->
        <form id="name_join" method="POST" action='#'>
            <input type="text" name="username" id="username" value="Name">
            <input type="text" name="join_room" id="join_room" value="Room Name">
            <input type="submit" value="Join Room">
        </form>
        <form id="start_room" method="POST" action='#'>
            <input type="text" name="start_room_button" id="start_room_button" value="Room Name" placeholder="Room Name" disabled>
            <input type="text" name="question_num" id="question_num" value="5">
            <input type="submit" value="Start Quiz">
        </form>
        <form id="leave" method="POST" action='#'>
            <input type="text" name="leave_room" id="leave_room" placeholder="Room Name">
            <input type="submit" value="Leave Room">
        </form>
        <!-- <form id="send_room" method="POST" action='#'>
            <input type="text" name="room_name" id="room_name" placeholder="Room Name">
            <input type="text" name="room_data" id="room_data" placeholder="Message">
            <input type="submit" value="Send to Room">
        </form> -->
        <!-- <form id="close" method="POST" action="#">
            <input type="text" name="close_room" id="close_room" placeholder="Room Name">
            <input type="submit" value="Close Room">
        </form> -->
        <!-- <form id="disconnect" method="POST" action="#">
            <input type="submit" value="Disconnect">
        </form> -->
    </div>
    <!-- <h2>Receive:</h2>
    <div id="log"></div> -->
    <h2>Leaderboard:</h2>
    <div id="room_leaderboard"></div>
    <h2>Room Details:</h2>
    <div id="room_stats"></div>
    <h2>Question:</h2>
    <div id="question_zone"></div>
</body>
</html>
